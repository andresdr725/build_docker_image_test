name: Build and Push to Harbor

on:
  push:
    branches: 
      - main
      # - develop
  pull_request:
    branches:
      - main

env:
  IMAGE_NAME: harbor-upload-docker-image-test-api  # Cambia por el nombre de tu imagen
  
jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout del c√≥digo
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2. Configurar Node.js (si necesitas testear)
      # - name: Setup Node.js
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: '18'
      #     cache: 'npm'
      
      # # 3. Instalar dependencias y testear (opcional)
      # - name: Install dependencies
      #   run: npm ci
      
      # - name: Run tests
      #   run: npm test
      #   continue-on-error: true  # No falla el pipeline si fallan los tests
      
      # 4. Preparar metadatos para Docker
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.HARBOR_URL }}/${{ secrets.HARBOR_PROJECT }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
      
      # 5. Login a Harbor
      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.HARBOR_URL }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}
      
      # 6. Setup Docker Buildx (para builds optimizados)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # 7. Build y Push de la imagen
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ secrets.HARBOR_URL }}/${{ secrets.HARBOR_PROJECT }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ secrets.HARBOR_URL }}/${{ secrets.HARBOR_PROJECT }}/${{ env.IMAGE_NAME }}:buildcache,mode=max
      
      # 8. Escanear imagen en Harbor (opcional)
      - name: Trigger Harbor scan
        run: |
          TAG="${GITHUB_REF#refs/heads/}-${GITHUB_SHA::7}"
          curl -X POST \
            -u "${{ secrets.HARBOR_USERNAME }}:${{ secrets.HARBOR_PASSWORD }}" \
            "https://${{ secrets.HARBOR_URL }}/api/v2.0/projects/${{ secrets.HARBOR_PROJECT }}/repositories/${{ env.IMAGE_NAME }}/artifacts/${TAG}/scan" \
            || echo "Scan trigger failed, but continuing..."
      
      # 9. Resultado
      - name: Image details
        run: |
          echo "‚úÖ Imagen construida y subida a Harbor:"
          echo "üê≥ ${{ secrets.HARBOR_URL }}/${{ secrets.HARBOR_PROJECT }}/${{ env.IMAGE_NAME }}"
          echo "üì¶ Tags: ${{ steps.meta.outputs.tags }}"